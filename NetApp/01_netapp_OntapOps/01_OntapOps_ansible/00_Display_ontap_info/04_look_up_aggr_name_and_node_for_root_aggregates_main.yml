#https://docs.ansible.com/ansible/latest/collections/netapp/ontap/index.html#plugins-in-netapp-ontap
---
- hosts: localhost
  connection: local
  gather_facts: false
  any_errors_fatal: true  # Stop playbook execution if any task fails

  collections:
    - netapp.ontap

  vars:
    sub_task: "04_look_up_aggr_name_and_node_for_root_aggregates_tasks.yml"
    output_f_name: "04_look_up_aggr_name_and_node_for_root_aggregates_tasks"
  vars_files:
    - vars.yml

  tasks:

    # Ensure the 'json' directory exists
    - name: Ensure the 'json' directory exists
      file:
        path: json
        state: directory
        mode: '0755'

    # Ensure absence of old freeze files
    - name: Ensure absence of old freeze files
      file:
        path: "json/{{ output_f_name }}_*.json"
        state: absent

    # Iterate over storages and conditionally run tasks
    - name: Gather and display ONTAP Aggregates info
      include_tasks: "{{ sub_task }}"
      when: item.enabled
      loop: "{{ storages }}"
      no_log: true

