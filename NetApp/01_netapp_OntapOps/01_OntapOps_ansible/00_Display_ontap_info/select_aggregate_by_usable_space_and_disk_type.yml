---
- hosts: localhost
  name: Select Aggregate
  gather_facts: false
  collections:
    - netapp.ontap
  vars_files:
    - vars.yml
  vars:
    #aggr_type: BSAS
    aggr_type: hdd 
    size: 1 #Gig
    login: &login 
      hostname: "{{ login.hostname }}"
      username: "{{ login.username }}"
      password: "{{ login.password }}"
      https: "{{ login.https }}"
      validate_certs: "{{ login.validate_certs }}"
    svms: "{{ svms }}"
  tasks:
  - name: Gather aggregate facts
    na_ontap_info:
      gather_subset: aggregate_info
      query:
        aggr-attributes:
          aggr-raid-attributes:
            aggregate-type: "{{ aggr_type }}"
      <<: *login
    register: netapp_info

  - set_fact:
      aggr_name: "{{ item }}"
    with_items: "{{ netapp_info.ontap_info.aggregate_info }}"
    when: 
    - aggr_name is not defined
    - "{{ netapp_info.ontap_info.aggregate_info[item].aggr_space_attributes.size_available | int / 1024 / 1024 / 1024 }}  > {{ size }}"
    #- netapp_info.ontap_info.aggregate_info[item].aggr_space_attributes.percent_used_capacity < used_cap
  - debug:
      msg: "{{ aggr_name }}"
